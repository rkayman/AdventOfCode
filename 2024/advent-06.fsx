open System

let test = """
....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...
"""

let input = """
......................#...#..............#.....................................#...#..............##..............................
......#.....#................#....#...........#........#......................#...............................#.....#.#.###..#...#
...#.#.................#........#.................#.........................................................#.....................
.....................................................................................................#.........#..................
.............................#.................#...................................#.....#....#........................#....#.....
..........................#.....................................................................#..#.............#................
.................#...........................#..........................#..............................#.#..#...................#.
..#....#....#......................................................................#....#.........................................
..................................#............#...........#...........................................#.#....#.............#.#...
...#...##....................................................................................#..........#..................#......
..................#.....#......#.....#...#.........#..#.............................#....##.............#...............##.#..#...
......#...............................................................................................................#..........#
...........#................................#.......#.............#...............#...................................#...........
............##...........................#........................................................................#...............
...............................#........#...#.................................#..#.#.............#...........#....................
........#..........#.#....................................................#........#....#..#.................................#....
.........#..............#........................#................................................................................
..................#..........................#.............#..................#.#...........#.....#...............................
...#...........#.#..........#.....................................................................................................
..............#.................#.....................................................................#...#......#.....#..........
..#.....#................................................................................................#.#.....#..........#.....
#.#..........#...#.............................#...............#..................................................#.#.............
..........................#..#.............#................................................................................#.....
...#..............................................................................................#..............#..#.......#.....
........................................#......#........................................#...................##...........#........
.............#..............#...........................##...#............#.....#..#..............................................
..#....#..#...............#........#.................#............................................#........##...............#.....
................................................#.......#...........##.............................#.##...........................
............................#..............#..#...........#...#.....#.#...................#.....#.............................#...
....................#....................................................................................#........................
.......................................................................................#.......................##..#..............
#.............................#.............................................................#............................#........
..............................................................................#.............#...#.........##......................
...............#..........................#.............#............#...........................................#................
................#........................#................................#...#............#.............................#........
..............................................................#.....#..........#.......#........#....#..................#.........
........................................................#..............................................................#.......#..
..#........#............#........#...#.....#.......#..............................................................................
..#..............#.#.....................................#..................................................#....##...............
............#........................#..........##.................................................................#........#.....
............#............#.#...............................................#.......#..............................................
..................#.........................................#............................#......#..................#...........#..
........................................................#.............##................................#........................#
.....................#...#......#.......#............#........#..................#...#.#....................................#.....
...........................................................................................#..............................#....#..
....#...................#.............#..........#..................................#.............................................
......................................#...............................................#..#........................................
.................#..#............................................#.............................................................#.#
............##...................................................................................#.........................#......
.........#.................................................#..#........................................#.....#..........#.....#...
.........#........................................................................................#.#...............#............#
..........#..#...........#...................#.....#.......#......#....#..#.......................#..........#..........#.........
......#...................................................#....#..............#....#.........##...#...............................
.........#........#........................#...........................................................#.......#................#.
.....................#...............................................#.##.........................................................
................................................................................#.............#..............#............#.......
......#..........#............................................#...#....................#...............................#.........#
......................................#....#.........#..............................................................#...#.........
.......##...#.#..........................................................#............#...........#........#...................#..
.....#............................................................................#............................#..................
....#..................#....#......#......#......................#......................#.......................................#.
..#..............#..#............#.................................#............#..................#................#.............
........................................................#....#...................................##.......................#.......
..........#..................................#....#........#.......#..........................#................#...............#..
.....................................#.................#..................#...........#...........................................
.........#..............#...................................................................................#...................#.
.................##.................................#.......#.......................................................#.........#...
...........#.................#..........................#...............................#..#...........................#..........
.....................................#...........................#...................#..............................#..#..........
.............................#.....#.................................................#.................##...............#.......#.
............#.........................................................................................................#...........
..........##.............#...................#.#...........................................#....................................##
..........#..#...#...............#........#........................................................#.................#............
....................#......................#....................................................#.#.....................#.........
.......................................#............#........................##............#....#..#..............................
..........#..........#.....................................#.................................#.......#............................
....#.............#...............................................................................................................
..#..............................................#....#......#........................................#.................#.........
...#......#.....#..............................#....#....................#......#..................#...................#.......#..
...............#..#...........................##..................................................................................
........#..#.....#.........................#.......#.............#..........................................#................#....
...#......#.............#...............#.............................................................................##..........
#.................................#.......#.........#.#.#...................................#...#.#...........#..........#........
#.........#....#...#.........#.#.............................................................#....................................
........................#.#.......#.................................................#.............................................
...#...##...#..#...........................#.....#..........................#...............................#.......#.............
................#..............................#..........##...................................................................#..
.......................................................................#...#..#...#.....#....#..................##..........#.....
#.....................#.........#........#.....................................................................#.....#.......#....
...........#......................#.......#.................................................#........................#............
.......#.........................................#.....#...#...........#................#....#......#...........#......#..........
....#.............#...............................#...#....#..#..#...........................................#.............#......
...#.........#..........................................#.....#...........^.#...#....#...........................#................
.....#..#...............#...........................#.#..........#........................................................#.......
.............#.......#.............................................................................................#...#..........
..#...................#...............................#......#............#...........#.......#...................................
...........#.......................#..........#...#.......................#..............#.............##.............#..#........
..#............#.............#.......................................................#.....##....................................#
.#.........#.....................................................................#.........#......................................
.............#....................................................................#.....#.............#...#...........#..........#
..........................#.....#...#......................#.................................#.....#.................#.......#....
..........#.#.....................................................................................................................
............#.......#....................#.......#.............................................#..................................
.......................................#..#........#...................................................#..........................
...................#........#....#........#..................#..........................................................#.........
........#..............#....................#............#......#...........#.....#..............................#.........#......
.......#.....#.................#.#..#..............................................................#.......#..#...........#......#
.#....................##.....................................................#...#.....#..........................................
...........#..................#.....#....#............#...............#....#............#.......................#.................
........#.....................................#......##............#..........................#..........#....................#...
..........................#...............................................................#.......................................
......................#..................................#.....................#.............................................#...#
.........#..............................................................#........##.........#.......#.............................
....#...#........#...........#....#.............#............#.....#..............................................................
...........#...............................................................................................#.......#..#...........
........#..........................#............................#...........#............#.............................#..........
.......#...........................#...#...............#..#..#...................#.........#......................................
..#..............................#........#...........#.......................................#...#...............................
.............#...#.............#.........#...........#.....................................#................#.....................
.........................#..........................#.................................#...........................................
..................##.............#........#......#............#........................#.......#......................#....#......
.....#............................................................................................................................
.#..................................#.....#.............#...#.............................................#..............#..##..#.
...............#........................................................#.........#..#..........#.........................#.......
.............................................#...................#.................#..................#......................#....
............................#.......................................................................................#.............
............#...............#....................#....#..........#..#..............................#......#.......#.......##......
............#.................................................................................#...................................
........................#...............................................................#......#.......#.......#.......###......#.
......................................#.#.........................................#.....#.............................#.........#.
"""

let parseInput (given: string) = 
    given.Split("\n", StringSplitOptions.RemoveEmptyEntries)
    |> Array.map _.ToCharArray()

type Direction = North | East | South | West 
type Turn = Left | Right
type Position = { r: int; c: int }
type PatrolMove<'T> =
    | Moved of 'T 
    | Blocked of 'T
    | Exited of 'T
type PatrolFinish<'T> = LeftRoom of 'T | LoopDetected of 'T

let hasExited pos size= 
    if 0 > pos.r || pos.r >= size then true  
    elif 0 > pos.c || pos.c >= size then true  
    else false
    
let isBlocked pos (room: char array array) = 
    room[pos.r][pos.c] = '#' || room[pos.r][pos.c] = 'O'

let move heading room=
    let dir, pos = heading 
    let pos' =
        match dir with
        | North -> { pos with r = pos.r - 1 }
        | East -> { pos with c = pos.c + 1 }
        | South -> { pos with r = pos.r + 1 }
        | West -> { pos with c = pos.c - 1 }
    if room |> Array.length |> hasExited pos' then Exited (dir, pos)
    elif room |> isBlocked pos' then Blocked (dir, pos)
    else Moved (dir, pos') 

let turnRight heading=
    match heading with
    | North -> East
    | East -> South 
    | South -> West 
    | West -> North
    
let rec patrol room path heading=
    match room |> move heading with
    | Exited heading' ->
        path |> Set.add heading' |> LeftRoom
    
    | Blocked heading' ->
        let dir' = heading' |> fst |> turnRight
        let pos' = heading' |> snd 
        let path' = path |> Set.add (dir', pos')
        patrol room path' (dir', pos') 

    | Moved heading' ->
        if path |> Set.contains heading' then
            path |> Set.add heading' |> LoopDetected
        else
            let path' = path |> Set.add heading' 
            patrol room path' heading' 

let findStartingPosition room =
    room
    |> Array.mapi (fun y xs ->
        xs
        |> Array.tryFindIndex (fun ch -> ch <> '.' && ch <> '#')
        |> Option.map (fun x -> { r = y; c = x }))
    |> Array.filter _.IsSome
    |> Array.tryExactlyOne
    |> Option.flatten

let part1 input = 
    let room = input |> parseInput
    let start =
        match room |> findStartingPosition with
        | None -> failwith "No starting position found"
        | Some pos ->
            match room[pos.r][pos.c] with
            | '^' -> North, pos
            | '>' -> East, pos
            | 'v' -> South, pos
            | '<' -> West, pos
            | _ -> failwith "Invalid starting position"
    
    let start' = [start] |> Set.ofList
        
    let path = start |> patrol room start'
    
    match path with
    | LeftRoom res -> 
        res
        |> Set.map snd
    | LoopDetected _ -> failwith "Loop detected where only left room should exist"

let part1Summary positions =
    positions |> Set.toList |> List.map (fun {r=r;c=c} -> (r,c)) |> printfn "%A"
    let distinctPathCount = positions |> Set.count
    printfn $"Visited %d{distinctPathCount} distinct positions"

let part2 given printSummary =
    let path = given |> part1
    if printSummary then path |> part1Summary
    
    let room = parseInput given 
    
    let _, pos as start =
        match room |> findStartingPosition with
        | None -> failwith "No starting position found"
        | Some pos ->
            match room[pos.r][pos.c] with
            | '^' -> North, pos
            | '>' -> East, pos
            | 'v' -> South, pos
            | '<' -> West, pos
            | _ -> failwith "Invalid starting position"
    
    let start' = [start] |> Set.ofList

    let path' = path |> Set.remove pos

    [
        for { r=r; c=c } in path' do
            room[r][c] <- 'O'
            yield patrol room start' start 
            room[r][c] <- '.'
    ]
    |> Set.ofList
    |> Set.filter (function | LoopDetected _ -> true | _ -> false)
    |> Set.count 
